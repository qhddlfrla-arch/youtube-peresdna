import { GoogleGenAI, Type } from "@google/genai";
import { AnalysisResult, NewPlan } from "../types";

const createAI = (apiKey: string) => {
  return new GoogleGenAI({ apiKey });
};

// API ??ê²€ì¦??¨ìˆ˜
export const validateApiKey = async (apiKey: string): Promise<boolean> => {
  try {
    const ai = createAI(apiKey);
    // ê°„ë‹¨???ŒìŠ¤???”ì²­?¼ë¡œ API ??ê²€ì¦?    const response = await ai.models.generateContent({
      model: "gemini-2.5-flash",
      contents: "Hello",
      config: {
        maxOutputTokens: 10,
      },
    });

    // ?‘ë‹µ???ˆìœ¼ë©?? íš¨????    return !!response.text;
  } catch (error) {
    console.error("API key validation failed:", error);
    return false;
  }
};

const structuredContentSchema = {
  type: Type.ARRAY,
  items: {
    type: Type.OBJECT,
    properties: {
      title: { type: Type.STRING, description: "The title of the section." },
      description: {
        type: Type.STRING,
        description:
          "The detailed content of the section. To ensure high readability, create clear separation between points using double line breaks instead of Markdown lists. Use `**bold text**` to emphasize important keywords or subheadings.",
      },
    },
    required: ["title", "description"],
  },
};

const baseAnalysisSchema = {
  type: Type.OBJECT,
  properties: {
    keywords: {
      type: Type.ARRAY,
      description: "A list of 5-10 core keywords from the video, in Korean.",
      items: { type: Type.STRING },
    },
    intent: {
      ...structuredContentSchema,
      description:
        "?ìƒ??ê¸°íš ?˜ë„ë¥?'ëª©í‘œ ?œì²­??, '?µì‹¬ ë©”ì‹œì§€', 'ê¸°ë? ?¨ê³¼' ?±ì˜ ?¹ì…˜?¼ë¡œ ?˜ëˆ„??êµ¬ì¡°?ìœ¼ë¡?ë¶„ì„?©ë‹ˆ?? ê°??¤ëª…?€ ê°€?…ì„±???’ì´ê¸??„í•´, ê¸€ë¨¸ë¦¬ ê¸°í˜¸(-) ?€??ë¬¸ë‹¨ ?¬ì´????ë²ˆì˜ ì¤„ë°”ê¿ˆì„ ?¬ìš©??ê³µë°±???•ë³´?˜ê³ , ì¤‘ìš”???¤ì›Œ?œëŠ” **êµµì? ê¸€??*ë¡?ê°•ì¡°?´ì£¼?¸ìš”.",
    },
    viewPrediction: {
      ...structuredContentSchema,
      description:
        "???ìƒ??ì¡°íšŒ?˜ê? ?’ì? ?´ìœ ë¥?'ê°ì •???°ê²°', '?¬íšŒ??ê³µê°?€', 'ì½˜í…ì¸?êµ¬ì¡°' ?±ì˜ ?¹ì…˜?¼ë¡œ ?˜ëˆ„??êµ¬ì¡°?ìœ¼ë¡?ë¶„ì„?©ë‹ˆ?? ?¬ëŸ¬ ??ª©???˜ì—´???ŒëŠ” ë°˜ë“œ??ê¸€ë¨¸ë¦¬ ê¸°í˜¸(-) ?€??ë¬¸ë‹¨ ?¬ì´????ë²ˆì˜ ì¤„ë°”ê¿ˆì„ ?¬ìš©?˜ì—¬ ê°€?…ì„±??ê·¹ë??”í•˜ê³? ì¤‘ìš”???Œì œëª©ì? **êµµì? ê¸€??*ë¡?ê°•ì¡°?´ì£¼?¸ìš”.",
    },
  },
  required: ["keywords", "intent", "viewPrediction"],
};

const storyChannelAnalysisSchema = {
  ...baseAnalysisSchema.properties,
  scriptStructure: {
    type: Type.ARRAY,
    description:
      "A step-by-step breakdown of the script's structure. Each step should have a title, purpose, and example quotes from the transcript, in Korean.",
    items: {
      type: Type.OBJECT,
      properties: {
        stage: {
          type: Type.STRING,
          description:
            "The stage of the script (e.g., '1?¨ê³„: ?œì„  ?Œê¸° ë°?ë¬¸ì œ/ê¸°íšŒ ?œê¸°').",
        },
        purpose: {
          type: Type.STRING,
          description:
            "The goal of this stage (e.g., 'ëª©ì  (ë¬´ì—‡???ë‹¨/?ì‚°? ì?)').",
        },
        quotes: {
          type: Type.ARRAY,
          description:
            "?¤í¬ë¦½íŠ¸?ì„œ ???¨ê³„ë¥?ê°€????ë³´ì—¬ì£¼ëŠ” ì§ì ‘?ì¸ ?¸ìš©êµ¬ì…?ˆë‹¤. ê°??¸ìš©êµ¬ì—???€?¬ê? ?˜ì˜¤???œê°„(?€?„ìŠ¤?¬í”„, ?? '01:23')??ë°˜ë“œ???¬í•¨?´ì•¼ ?©ë‹ˆ?? ?¤í¬ë¦½íŠ¸???€?„ìŠ¤?¬í”„ê°€ ?†ë‹¤ë©? ?ìƒ???„ì²´ ê¸¸ì´ë¥?ê³ ë ¤?˜ì—¬ ?ˆìƒ ?œê°„??MM:SS ?•ì‹?¼ë¡œ ê¸°ì¬?´ì£¼?¸ìš”.",
          items: {
            type: Type.OBJECT,
            properties: {
              timestamp: {
                type: Type.STRING,
                description: "?¸ìš©êµ¬ì˜ ?€?„ìŠ¤?¬í”„ (MM:SS ?•ì‹).",
              },
              text: { type: Type.STRING, description: "?¸ìš©êµ¬ì˜ ?´ìš©." },
            },
            required: ["timestamp", "text"],
          },
        },
      },
      required: ["stage", "purpose", "quotes"],
    },
  },
};

const newPlanBaseSchema = {
  newIntent: {
    ...structuredContentSchema,
    description:
      "?ˆë¡œ???ìƒ??ê¸°íš ?˜ë„ë¥?'ëª©í‘œ', '?µì‹¬ ì»¨ì…‰', '?œì²­?ì—ê²?ì¤?ê°€ì¹? ?±ì˜ ?¹ì…˜?¼ë¡œ ?˜ëˆ„??êµ¬ì¡°?ìœ¼ë¡??‘ì„±?©ë‹ˆ?? ê°??¤ëª…?€ ê°€?…ì„±???’ì´ê¸??„í•´, ê¸€ë¨¸ë¦¬ ê¸°í˜¸(-) ?€??ë¬¸ë‹¨ ?¬ì´????ë²ˆì˜ ì¤„ë°”ê¿ˆì„ ?¬ìš©??ê³µë°±???•ë³´?˜ê³ , ì¤‘ìš”???¤ì›Œ?œëŠ” **êµµì? ê¸€??*ë¡?ê°•ì¡°?´ì£¼?¸ìš”.",
  },
};

const storyChannelNewPlanSchema = {
  type: Type.OBJECT,
  properties: {
    ...newPlanBaseSchema,
    characters: {
      type: Type.ARRAY,
      description:
        "?€ë³¸ì— ?±ì¥?˜ëŠ” ëª¨ë“  ?¸ë¬¼ ?ëŠ” ?”ì??ëª©ë¡?…ë‹ˆ?? (?? '?˜ë ˆ?´í„°', 'ì¶œì—°??A')",
      items: { type: Type.STRING },
    },
    scriptWithCharacters: {
      type: Type.ARRAY,
      description:
        "?ˆë¡œ???ìƒ???€???ì„¸?? ??ì¤???ì¤„ì˜ ?€ë³¸ì…?ˆë‹¤. ê°?ê°ì²´???”ì, ?€?? ?€?„ìŠ¤?¬í”„(?ˆìƒ ?œê°„), ê·¸ë¦¬ê³??´ë‹¹ ?¥ë©´???€???´ë?ì§€ ?ì„± ?„ë¡¬?„íŠ¸ë¥??¬í•¨?´ì•¼ ?©ë‹ˆ??",
      items: {
        type: Type.OBJECT,
        properties: {
          character: {
            type: Type.STRING,
            description: "???€?¬ë? ë§í•˜???¸ë¬¼ ?ëŠ” ?”ì?…ë‹ˆ??",
          },
          line: {
            type: Type.STRING,
            description:
              "???€?¬ì˜ ?€???ëŠ” ?‰ë™?…ë‹ˆ?? ë§ˆí¬?¤ìš´ ?¬ìš©??ê°€?¥í•©?ˆë‹¤.",
          },
          timestamp: {
            type: Type.STRING,
            description:
              "???€?¬ê? ?±ì¥???ˆìƒ ?œê°„ (MM:SS ?•ì‹, ?? '00:15', '01:30'). **ì¤‘ìš”**: ?œêµ­????… ?ë„??**ë¶„ë‹¹ ??300-350????5-6??ì´?**?…ë‹ˆ?? ê°??€?¬ì˜ ê¸€???˜ë? ?¸ê³ , ?´ì „ ?€?¬ë“¤???„ì  ?œê°„???”í•´ ?•í™•???€?„ìŠ¤?¬í”„ë¥?ê³„ì‚°?˜ì„¸?? ?ˆë? ?¤ì–´, 50???€?¬ëŠ” ??8-10ì´ˆê? ?Œìš”?©ë‹ˆ?? ?€???¬ì´???ì—°?¤ëŸ¬???¸í¡(1-2ì´???ê³ ë ¤?˜ì„¸??",
          },
          imagePrompt: {
            type: Type.STRING,
            description:
              "???€?¬ì? ?¥ë©´???´ìš¸ë¦¬ëŠ” ?´ë?ì§€ë¥??ì„±?˜ê¸° ?„í•œ ?ì„¸???„ë¡¬?„íŠ¸?…ë‹ˆ?? DALL-E ?ëŠ” Midjourney?€ ê°™ì? ?´ë?ì§€ ?ì„± AI???¬ìš©?????ˆë„ë¡??ì–´ë¡??‘ì„±?´ì£¼?¸ìš”.\n\n**ë²”ìš© ?„ë¡¬?„íŠ¸ êµ¬ì¡° (Universal Prompt Skeleton)**:\n{Style}, {Composition} of {Subject}, {Action}, in {Background}, with {Lighting}, {Mood}, {Quality}\n\n- {Style}: ì¹´í…Œê³ ë¦¬ ?¹ì„± ë°˜ì˜ ?¤í???(?? cinematic photo, digital art, candid vlog style)\n- {Composition}: êµ¬ë„?€ ?µê? (?? close-up shot, wide angle, full body shot)\n- {Subject}: ?€ë³¸ì—??ì¶”ì¶œ???¸ë¬¼/?¬ë¬¼ ?ì„¸ ë¬˜ì‚¬ (?? a young woman with long brown hair)\n- {Action}: ?¸ë¬¼???‰ë™/?í™© (?? reading a book, looking at city view)\n- {Background}: ?¥ë©´ ë°°ê²½ (?? cozy living room, bustling street at night)\n- {Lighting}: ì¡°ëª… ?¨ê³¼ (?? soft natural light, dramatic neon lighting)\n- {Mood}: ?„ì²´ ë¶„ìœ„ê¸?(?? peaceful and serene, mysterious and tense)\n- {Quality}: ?ˆì§ˆ ?¤ì›Œ??(?? highly detailed, 8K, photorealistic)\n\n**ì¤‘ìš”**: ?¤ì œ ?¬ì§„ ?¤í??¼ë³´?¤ëŠ” illustration style, digital art, anime style, webtoon style ??AIê°€ ?ì„±?˜ê¸° ?¬ìš´ ?ˆìˆ ???¤í??¼ì„ ?°ì„ ?ìœ¼ë¡??¬ìš©?˜ì„¸??",
          },
        },
        required: ["character", "line", "timestamp", "imagePrompt"],
      },
    },
  },
  required: ["newIntent", "characters", "scriptWithCharacters"],
};

const structuredOutlinePlanSchema = {
  type: Type.OBJECT,
  properties: {
    ...newPlanBaseSchema,
    scriptOutline: {
      type: Type.ARRAY,
      description:
        "A step-by-step breakdown of the new video's outline. Each step should have a title, purpose, and detailed content, in Korean. Use markdown for the details.",
      items: {
        type: Type.OBJECT,
        properties: {
          stage: {
            type: Type.STRING,
            description: "The stage of the outline (e.g., '1?¨ê³„: ?„ì…ë¶€').",
          },
          purpose: {
            type: Type.STRING,
            description: "The goal of this stage.",
          },
          details: {
            type: Type.STRING,
            description:
              "Detailed content for this stage. To ensure high readability, create clear separation between points using double line breaks instead of Markdown lists. Use `**bold text**` to emphasize important keywords or subheadings.",
          },
        },
        required: ["stage", "purpose", "details"],
      },
    },
  },
  required: ["newIntent", "scriptOutline"],
};

const ideaSchema = {
  type: Type.OBJECT,
  properties: {
    ideas: {
      type: Type.ARRAY,
      description:
        "A list of 5 new video topic ideas or product recommendations, in Korean.",
      items: { type: Type.STRING },
    },
  },
  required: ["ideas"],
};

export const analyzeTranscript = async (
  transcript: string,
  category: string,
  apiKey: string,
  videoTitle?: string
): Promise<AnalysisResult> => {
  try {
    const ai = createAI(apiKey);

    const fullAnalysisSchema = {
      type: Type.OBJECT,
      properties: storyChannelAnalysisSchema,
      required: [...baseAnalysisSchema.required, "scriptStructure"],
    };

    const analysisContext = videoTitle
      ? `?¤ìŒ?€ ?œëª©??"${videoTitle}"???±ê³µ?ì¸ '${category}' ì¹´í…Œê³ ë¦¬ YouTube ?™ì˜?ì…?ˆë‹¤. ?ìƒ???œëª©ê³??¤í¬ë¦½íŠ¸ë¥?ì¢…í•©?ìœ¼ë¡?ê³ ë ¤?˜ì—¬ ?¬ì¸µ?ìœ¼ë¡?ë¶„ì„?˜ê³ , ê°???ª©??ì§€?•ëœ êµ¬ì¡°??ë§ì¶° JSON ?•ì‹?¼ë¡œ ?œê³µ?´ì£¼?¸ìš”:`
      : `?¤ìŒ?€ ?±ê³µ?ì¸ '${category}' ì¹´í…Œê³ ë¦¬ YouTube ?™ì˜?ì˜ ?¤í¬ë¦½íŠ¸?…ë‹ˆ?? ??ì¹´í…Œê³ ë¦¬???¹ì„±??ê³ ë ¤?˜ì—¬ ?¬ì¸µ?ìœ¼ë¡?ë¶„ì„?˜ê³ , ê°???ª©??ì§€?•ëœ êµ¬ì¡°??ë§ì¶° JSON ?•ì‹?¼ë¡œ ?œê³µ?´ì£¼?¸ìš”:`;

    const response = await ai.models.generateContent({
      model: "gemini-2.5-flash",
      contents: `${analysisContext}\n\n?¤í¬ë¦½íŠ¸:\n---\n${transcript}\n---`,
      config: {
        systemInstruction: `?¹ì‹ ?€ '${category}' ?„ë¬¸ YouTube ì½˜í…ì¸??„ëµê°€?…ë‹ˆ?? ?¹ì‹ ???„ë¬´??ë¹„ë””???¤í¬ë¦½íŠ¸ë¥?ë¶„ì„?˜ê³  ë²¤ì¹˜ë§ˆí‚¹???„í•´ ?µì‹¬ ?”ì†Œ???€??êµ¬ì¡°?”ëœ ë¶„ì„???œê³µ?˜ëŠ” ê²ƒì…?ˆë‹¤. ëª¨ë“  ?ìŠ¤???¤ëª…?€ ê°€?…ì„±???„í•´ **êµµì? ê¸€??*ë¥??œìš©?˜ê³ , ê¸€ë¨¸ë¦¬ ê¸°í˜¸(-) ?€??ë¬¸ë‹¨ ?¬ì´????ë²ˆì˜ ì¤„ë°”ê¿ˆì„ ?¬ìš©?˜ì—¬ ëª…í™•?˜ê²Œ êµ¬ë¶„?´ì£¼?¸ìš”.`,
        responseMimeType: "application/json",
        responseSchema: fullAnalysisSchema,
      },
    });

    const jsonText = response.text.trim();
    return JSON.parse(jsonText) as AnalysisResult;
  } catch (error: any) {
    console.error("Error analyzing transcript:", error);
    
    let userMessage = "???¤í¬ë¦½íŠ¸ ë¶„ì„ ì¤??¤ë¥˜ê°€ ë°œìƒ?ˆìŠµ?ˆë‹¤.\n\n";
    
    if (error.message && error.message.includes('API_KEY')) {
      userMessage += "?“Œ ?ì¸:\n??API ?¤ê? ? íš¨?˜ì? ?Šê±°??ë§Œë£Œ?˜ì—ˆ?µë‹ˆ??n\n?’¡ ?´ê²° ë°©ë²•:\n??API ?¤ë? ?¤ì‹œ ?•ì¸?˜ê³  ?¬ì„¤?•í•´ì£¼ì„¸??n??API ??ë°œê¸‰ ê°€?´ë“œë¥?ì°¸ê³ ?˜ì—¬ ?ˆë¡œ???¤ë? ë°œê¸‰ë°›ìœ¼?¸ìš”";
    } else if (error.message && error.message.includes('quota')) {
      userMessage += "?“Œ ?ì¸:\n??API ?¬ìš©?‰ì´ ì´ˆê³¼?˜ì—ˆ?µë‹ˆ??n\n?’¡ ?´ê²° ë°©ë²•:\n??? ì‹œ ???¤ì‹œ ?œë„?´ì£¼?¸ìš”\n??Google AI Studio?ì„œ API ?¬ìš©?‰ì„ ?•ì¸?´ì£¼?¸ìš”";
    } else if (error.message && error.message.includes('rate')) {
      userMessage += "?“Œ ?ì¸:\n??API ?”ì²­???ˆë¬´ ë¹ ë¥´ê²?ë°œìƒ?ˆìŠµ?ˆë‹¤\n\n?’¡ ?´ê²° ë°©ë²•:\n??10ì´??•ë„ ê¸°ë‹¤ë¦????¤ì‹œ ?œë„?´ì£¼?¸ìš”";
    } else {
      userMessage += "?“Œ ê°€?¥í•œ ?ì¸:\n???¤í¬ë¦½íŠ¸ ê¸¸ì´ê°€ ?ˆë¬´ ê¸¸ê±°???•ì‹???¬ë°”ë¥´ì? ?ŠìŠµ?ˆë‹¤\n??AI ?œë²„ ?¼ì‹œ???¤ë¥˜\n???¤íŠ¸?Œí¬ ?°ê²° ë¬¸ì œ\n\n?’¡ ?´ê²° ë°©ë²•:\n???¤í¬ë¦½íŠ¸ë¥?ì§§ê²Œ ?˜ëˆ ???¤ì‹œ ?œë„?´ì£¼?¸ìš”\n??? ì‹œ ???¤ì‹œ ?œë„?´ì£¼?¸ìš”";
    }
    
    userMessage += `\n\n?”§ ê°œë°œ?ì—ê²??„ë‹¬???¤ë¥˜ ?•ë³´:\n${error.message || '?????†ëŠ” ?¤ë¥˜'}\n${error.stack ? '\nStack: ' + error.stack : ''}`;
    
    throw new Error(userMessage);
  }
};

export const generateIdeas = async (
  analysis: AnalysisResult,
  category: string,
  apiKey: string,
  userKeyword?: string
): Promise<string[]> => {
  try {
    const ai = createAI(apiKey);

    const analysisString = JSON.stringify(
      {
        keywords: analysis.keywords,
        intent: analysis.intent,
      },
      null,
      2
    );

    const isShoppingReview = category === "?¼í•‘ ë¦¬ë·°";
    const keywordInstruction = userKeyword
      ? `\n\n**ì¤‘ìš”: ?¬ìš©?ê? ?í•˜???¤ì›Œ??"${userKeyword}"ë¥?ë°˜ë“œ???¬í•¨?˜ê±°??ê´€?¨ëœ ?„ì´?”ì–´ë¥??ì„±?´ì£¼?¸ìš”.**`
      : "";

    const prompt = isShoppingReview
      ? `?¤ìŒ?€ ?±ê³µ?ì¸ '?¼í•‘ ë¦¬ë·°' ?ìƒ ë¶„ì„ ê²°ê³¼?…ë‹ˆ?? ??ë¶„ì„??ë°”íƒ•?¼ë¡œ, ?œêµ­???´ì»¤ë¨¸ìŠ¤ ?¬ì´??'ì¿ íŒ¡(Coupang)'?ì„œ ?„ì¬ ?ë§¤?‰ì´ ê°€??ë§ê±°???„ê¸°ê°€ ë§ì? ?œí’ˆ ì¤? ?ìƒ ë¦¬ë·° ì½˜í…ì¸ ë¡œ ë§Œë“¤ê¸°ì— ?í•©???œí’ˆ 5ê°€ì§€ë¥?ì¶”ì²œ?´ì£¼?¸ìš”. ?„ì´?”ì–´???œêµ­?´ë¡œ ?‘ì„±?˜ê³  JSON ?•ì‹??ë°°ì—´ë¡??œê³µ?´ì£¼?¸ìš”.${keywordInstruction}\n\në¶„ì„ ?´ìš©:\n${analysisString}`
      : `?¤ìŒ?€ ?±ê³µ?ì¸ ? íŠœë¸??ìƒ ë¶„ì„ ê²°ê³¼?…ë‹ˆ?? ??ë¶„ì„??ë°”íƒ•?¼ë¡œ, ë¹„ìŠ·???±ê³µ ê°€?¥ì„±???ˆëŠ” ?ˆë¡­ê³?ì°½ì˜?ì¸ ?ìƒ ì£¼ì œ ?„ì´?”ì–´ 5ê°€ì§€ë¥??œì•ˆ?´ì£¼?¸ìš”. ?„ì´?”ì–´???œêµ­?´ë¡œ ?‘ì„±?˜ê³  JSON ?•ì‹??ë°°ì—´ë¡??œê³µ?´ì£¼?¸ìš”.${keywordInstruction}\n\në¶„ì„ ?´ìš©:\n${analysisString}`;

    const systemInstruction = isShoppingReview
      ? "?¹ì‹ ?€ ìµœì‹  ?¸ë Œ?œì— ë°ì? ?¼í•‘ ?„ë¬¸ê°€?…ë‹ˆ?? ?±ê³µ?ì¸ ë¦¬ë·° ?ìƒ??ë¶„ì„?˜ì—¬, ?¤ìŒ ?ˆíŠ¸??ë§Œí•œ ë¦¬ë·° ?œí’ˆ??ì¶”ì²œ?˜ëŠ” ??• ???©ë‹ˆ??"
      : "?¹ì‹ ?€ ?¸ë Œ?œë? ???½ëŠ” ? íŠœë¸?ì½˜í…ì¸?ê¸°íš?ì…?ˆë‹¤. ?±ê³µ ?¬ë?ë¥?ë¶„ì„?˜ì—¬ ?ˆë¡œ???ˆíŠ¸ ?„ì´?”ì–´ë¥??œì•ˆ?˜ëŠ” ??• ???©ë‹ˆ??";

    const response = await ai.models.generateContent({
      model: "gemini-2.5-flash",
      contents: prompt,
      config: {
        systemInstruction: systemInstruction,
        responseMimeType: "application/json",
        responseSchema: ideaSchema,
      },
    });

    const jsonText = response.text.trim();
    const result = JSON.parse(jsonText);
    return result.ideas as string[];
  } catch (error: any) {
    console.error("Error generating ideas:", error);
    
    let userMessage = "???„ì´?”ì–´ ?ì„± ì¤??¤ë¥˜ê°€ ë°œìƒ?ˆìŠµ?ˆë‹¤.\n\n";
    
    if (error.message && error.message.includes('API_KEY')) {
      userMessage += "?“Œ ?ì¸:\n??API ?¤ê? ? íš¨?˜ì? ?Šê±°??ë§Œë£Œ?˜ì—ˆ?µë‹ˆ??n\n?’¡ ?´ê²° ë°©ë²•:\n??API ?¤ë? ?¤ì‹œ ?•ì¸?˜ê³  ?¬ì„¤?•í•´ì£¼ì„¸??;
    } else if (error.message && error.message.includes('quota')) {
      userMessage += "?“Œ ?ì¸:\n??API ?¬ìš©?‰ì´ ì´ˆê³¼?˜ì—ˆ?µë‹ˆ??n\n?’¡ ?´ê²° ë°©ë²•:\n??? ì‹œ ???¤ì‹œ ?œë„?´ì£¼?¸ìš”\n??Google AI Studio?ì„œ API ?¬ìš©?‰ì„ ?•ì¸?´ì£¼?¸ìš”";
    } else if (error.message && error.message.includes('rate')) {
      userMessage += "?“Œ ?ì¸:\n??API ?”ì²­???ˆë¬´ ë¹ ë¥´ê²?ë°œìƒ?ˆìŠµ?ˆë‹¤\n\n?’¡ ?´ê²° ë°©ë²•:\n??10ì´??•ë„ ê¸°ë‹¤ë¦????¤ì‹œ ?œë„?´ì£¼?¸ìš”";
    } else {
      userMessage += "?“Œ ê°€?¥í•œ ?ì¸:\n??AI ?œë²„ ?¼ì‹œ???¤ë¥˜\n???¤íŠ¸?Œí¬ ?°ê²° ë¬¸ì œ\n\n?’¡ ?´ê²° ë°©ë²•:\n??? ì‹œ ???¤ì‹œ ?œë„?´ì£¼?¸ìš”\n???ˆë¡œê³ ì¹¨ ???¤ì‹œ ?œë„?´ì£¼?¸ìš”";
    }
    
    userMessage += `\n\n?”§ ê°œë°œ?ì—ê²??„ë‹¬???¤ë¥˜ ?•ë³´:\n${error.message || '?????†ëŠ” ?¤ë¥˜'}\n${error.stack ? '\nStack: ' + error.stack : ''}`;
    
    throw new Error(userMessage);
  }
};

export const generateNewPlan = async (
  analysis: AnalysisResult,
  newKeyword: string,
  length: string,
  category: string,
  apiKey: string,
  vlogType?: string
): Promise<NewPlan> => {
  try {
    const ai = createAI(apiKey);

    // scriptStructure?ì„œ ?ë³¸ ?€ë³¸ì˜ ?¸ìš©êµ?quotes)ë¥??œê±°?˜ì—¬
    // êµ¬ì¡°?€ ëª©ì ë§??„ë‹¬?˜ê³ , ?ë³¸ ?€ë³??´ìš©?????€ë³¸ì— ?í–¥??ì£¼ì? ?Šë„ë¡???    const cleanedScriptStructure = analysis.scriptStructure?.map((stage) => ({
      stage: stage.stage,
      purpose: stage.purpose,
      // quotes???œê±° - ?ë³¸ ?€ë³??´ìš© ?„ì¶œ ë°©ì?
    }));

    const analysisString = JSON.stringify(
      {
        keywords: analysis.keywords,
        intent: analysis.intent,
        scriptStructure: cleanedScriptStructure,
      },
      null,
      2
    );

    const isStoryChannel = category === "??ì±„ë„";
    const isVlogChannel = category === "ë¸Œì´ë¡œê·¸";
    const is49Channel = category === "49ê¸?;
    const isYadamChannel = category === "?¼ë‹´";
    const isMukbangChannel = category === "ë¨¹ë°©";
    const isGukppongChannel = category === "êµ?½•";
    const isNorthKoreaChannel = category === "ë¶í•œ ?´ìŠˆ";
    const schema =
      isStoryChannel || is49Channel || isYadamChannel || isGukppongChannel || isNorthKoreaChannel
        ? storyChannelNewPlanSchema
        : structuredOutlinePlanSchema;

    let contents;
    
    // ?ìƒ ê¸¸ì´???°ë¥¸ ìµœì†Œ ?€ë³??¼ì¸ ??ê³„ì‚°
    const getMinimumLines = (lengthStr: string): number => {
      if (lengthStr.includes('1?œê°„') || lengthStr.includes('60ë¶?)) return 200;
      if (lengthStr.includes('30ë¶?)) return 100;
      if (lengthStr.includes('8ë¶?)) return 30;
      return 30;
    };
    
    const minimumLines = getMinimumLines(length);
    const lengthGuideline = length.includes('1?œê°„') || length.includes('60ë¶?)
      ? `\n\n**? ï¸ ì¤‘ìš”: ?ìƒ ê¸¸ì´ ê°€?´ë“œ (${length})**\n- ìµœì†Œ ${minimumLines}ê°??´ìƒ???€???¼ì¸???ì„±?´ì•¼ ?©ë‹ˆ??n- 1?œê°„ = ??18,000-21,000??ë¶„ëŸ‰ (?œêµ­????… ?ë„ ê¸°ì?)\n- ê°??€?¬ëŠ” ?ì—°?¤ëŸ¬???€??ê¸¸ì´ë¡??‘ì„±?˜ë˜, ?„ì²´ ?¤í† ë¦¬ê? ${length} ë¶„ëŸ‰??ë§ë„ë¡?ì¶©ë¶„???ì„¸?˜ê²Œ ?‘ì„±?˜ì„¸??n- ?¥ë©´ ?„í™˜, ë³µì„ , ?´ë¼?´ë§¥?????¤í† ë¦??”ì†Œë¥??ë??˜ê²Œ ?¬í•¨?˜ì„¸??n- ?€???¬ì´???ì—°?¤ëŸ¬??ê°„ê²©ê³?ê°ì • ?œí˜„??ì¶©ë¶„???´ì•„ì£¼ì„¸??
      : `\n\n**?ìƒ ê¸¸ì´ ê°€?´ë“œ (${length})**: ìµœì†Œ ${minimumLines}ê°??´ìƒ???€???¼ì¸???ì„±?˜ì„¸??`;
    
    if (isStoryChannel) {
      contents = `"${newKeyword}"ë¥?ì£¼ì œë¡????„ì „???ˆë¡œ???¤í† ë¦??ìƒ ê¸°íš?ˆì„ ë§Œë“¤??ì£¼ì„¸?? ëª©í‘œ ?ìƒ ê¸¸ì´????${length}?…ë‹ˆ??${lengthGuideline}

**?ˆë? ê·œì¹™:**
- ?„ë˜ ?œê³µ??ë¶„ì„ ?ë£Œ??**?€ë³?êµ¬ì¡°(?¨ê³„ë³??ë¦„)**ë§?ì°¸ê³ ?˜ì„¸??- ?ë³¸ ?ìƒ???±ì¥?¸ë¬¼, ?í™©, ë°°ê²½, ?€?¬ëŠ” ?ˆë? ?¬ìš©?˜ì? ë§ˆì„¸??- "${newKeyword}"ë¥?ì¤‘ì‹¬?¼ë¡œ ?„ì „???ˆë¡œ???¸ë¬¼, ?í™©, ?¤í† ë¦¬ë? ì°½ì‘?˜ì„¸??
**ì¤‘ìš”: ë°°ì—­ êµ¬ì„± ì§€ì¹?*
- '?˜ë ˆ?´í„°'ë§??¬ìš©?˜ì? ë§ê³ , ?¤í† ë¦¬ì— ?´ìš¸ë¦¬ëŠ” ?¤ì–‘??ë°°ì—­??ë§Œë“¤?´ì£¼?¸ìš”.
- ë°°ì—­ ?ˆì‹œ: ì£¼ì¸ê³? ì¹œêµ¬, ?ë?ë°? ?„ë§ˆ, ?„ë¹ , ? ìƒ?? ?™ë£Œ, ?„ë°°, ? ë°°, ì§€?? ?¬ì¥????- ?¤í† ë¦¬ì˜ ë§¥ë½??ë§ëŠ” 2~5ëª…ì˜ ìºë¦­?°ë? ?±ì¥?œì¼œ ?€?”í˜• ?•ì‹?¼ë¡œ ?‘ì„±?´ì£¼?¸ìš”.
- ê°?ìºë¦­?°ëŠ” êµ¬ì²´?ì¸ ??• ëª??? '??, 'ì¹œêµ¬ ë¯¼ìˆ˜', '?„ë§ˆ', '?Œì‚¬ ?™ë£Œ')???¬ìš©?´ì£¼?¸ìš”.
- ?˜ë ˆ?´ì…˜???„ìš”??ê²½ìš°?ë§Œ '?˜ë ˆ?´í„°'ë¥??¬ìš©?˜ë˜, ?€ë¶€ë¶„ì˜ ?´ìš©?€ ìºë¦­??ê°„ì˜ ?€?”ì? ?‰ë™?¼ë¡œ ?œí˜„?´ì£¼?¸ìš”.

ê°??€?¬ë§ˆ???´ë‹¹ ?¥ë©´???œê°?ìœ¼ë¡?ë¬˜ì‚¬?˜ëŠ” ?ì„¸???´ë?ì§€ ?ì„± ?„ë¡¬?„íŠ¸('imagePrompt')ë¥?ë°˜ë“œ???¬í•¨?´ì•¼ ?©ë‹ˆ??

**?´ë?ì§€ ?„ë¡¬?„íŠ¸ ?‘ì„± ê°€?´ë“œ - ??ì±„ë„ ?¤í???*:
- ?µì‹¬ ?¤ì›Œ?? cinematic, dramatic lighting, moody, mysterious, suspenseful, narrative still
- ?¤í???ê°•ì¡°: ?í™”?????¥ë©´ì²˜ëŸ¼ ê·¹ì ?´ê³  ?œì‚¬?ì¸ ?ë‚Œ
- ì¡°ëª…ê³?ë¶„ìœ„ê¸°ì— ì§‘ì¤‘?˜ì—¬ ê¸´ì¥ê°?ì¡°ì„±
- ?ˆì‹œ: "cinematic shot of a person in shock, dramatic lighting, moody atmosphere, mysterious background, highly detailed, film noir style"

**ì°¸ê³ ???€ë³?êµ¬ì¡° (êµ¬ì¡°ë§?ì°¨ìš©, ?´ìš©?€ ?ˆë? ?¬ìš© ê¸ˆì?):**

${analysisString}

??êµ¬ì¡°???¨ê³„ë³??ë¦„(?? ?„ì…?’ì „ê°œâ†’?ˆì •?’ê²°ë§?ë§?ì°¸ê³ ?˜ì—¬, "${newKeyword}"ë¥?ì£¼ì œë¡??„ì „???ˆë¡œ???¤í† ë¦¬ë? ì°½ì‘?´ì£¼?¸ìš”. ëª¨ë“  ê²°ê³¼ ??ª©??ì§€?•ëœ êµ¬ì¡°??ë§ì¶° JSON ?•ì‹?¼ë¡œ ?œê³µ?´ì£¼?¸ìš”.`;
    } else if (isVlogChannel) {
      const vlogTypePrompts: Record<string, string> = {
        "ëª¨ë‹ ë£¨í‹´":
          "?„ì¹¨ ?œê°„?€??ë£¨í‹´??ì¤‘ì‹¬?¼ë¡œ, ê¸°ìƒë¶€???¸ì¶œ ì¤€ë¹„ê¹Œì§€??ê³¼ì •???ì—°?¤ëŸ½ê²?ë³´ì—¬ì£¼ì„¸?? ê±´ê°•???µê?, ?„ì¹¨ ?ì‚¬, ë©”ì´?¬ì—…/?¤í??¼ë§, ì¶œê·¼/?±êµ ì¤€ë¹??±ì„ ?¬í•¨?˜ì„¸??",
        ?¤ì´?´íŠ¸:
          "?¤ì´?´íŠ¸ ?¬ì •ê³??¼ìƒ???´ì•„ì£¼ì„¸?? ?ë‹¨ ê´€ë¦? ?´ë™ ë£¨í‹´, ì²´ì¤‘/ì²´í˜• ë³€?? ê±´ê°•???µê? ë§Œë“¤ê¸? ?™ê¸°ë¶€?¬ì? ëª©í‘œ ?¬ì„± ê³¼ì •???”ì§?˜ê²Œ ê³µìœ ?˜ì„¸??",
        ?¬í–‰: "?¬í–‰ì§€ ?ë°©ê³?ê²½í—˜??ì¤‘ì‹¬?¼ë¡œ êµ¬ì„±?˜ì„¸?? ?´ë™ ê³¼ì •, ëª…ì†Œ ë°©ë¬¸, ë¡œì»¬ ?Œì‹, ?™ì†Œ ?¬ì–´, ?¬í–‰ ?ì„ ?ì—°?¤ëŸ½ê²??¹ì—¬?´ì„¸??",
        ?¸ë°•??
          "?ˆë¡œ êµ¬ë§¤???œí’ˆ?¤ì„ ?¸ë°•?±í•˜ê³??Œê°œ?˜ëŠ” ê³¼ì •???´ì•„ì£¼ì„¸?? êµ¬ë§¤ ?™ê¸°, ê°€ê²? ì°©ìš©/?¬ìš© ?„ê¸°ë¥??”ì§?˜ê²Œ ?„ë‹¬?˜ì„¸??",
        ?¨ì…˜: "?¨ì…˜ê³??¤í??¼ë§??ì¤‘ì‹¬?¼ë¡œ êµ¬ì„±?˜ì„¸?? ì½”ë”” ?„ì´?”ì–´, OOTD, ?¼í•‘ ?˜ìš¸, ?¤í??¼ë§ ?? ?¸ë Œ???Œê°œë¥?ê°ê°?ìœ¼ë¡??´ì•„ì£¼ì„¸??",
        ê³µë?: "ê³µë??˜ëŠ” ëª¨ìŠµê³??™ìŠµ ë°©ë²•??ë³´ì—¬ì£¼ì„¸?? ì±…ìƒ ?¸íŒ…, ê³µë? ?€?„ë©?? ì§‘ì¤‘??? ì? ?? ?´ì‹ ?œê°„???ì—°?¤ëŸ½ê²?êµ¬ì„±?˜ì„¸??",
        ?´ë™: "?´ë™ ë£¨í‹´ê³?ê³¼ì •???´ì•„ì£¼ì„¸?? ì¤€ë¹„ìš´?? ë³??´ë™, ?ë‹¨ ê´€ë¦? ?™ê¸°ë¶€??ë©”ì‹œì§€ë¥??¬í•¨?˜ì—¬ ê±´ê°•???¼ì´?„ìŠ¤?€?¼ì„ ë³´ì—¬ì£¼ì„¸??",
        ?¼ìƒ: "?¹ë³„???Œë§ˆ ?†ì´ ?˜ë£¨???ì—°?¤ëŸ¬???ë¦„???´ì•„ì£¼ì„¸?? ?¼ê³¼, ?Œì†Œ???‰ë³µ, ?ˆìƒì¹?ëª»í•œ ?œê°„?¤ì„ ?”ì§?˜ê²Œ ê³µìœ ?˜ì„¸??",
        ?°ì´??
          "?°ì´??ê³¼ì •??ë¡œë§¨?±í•˜ê²??´ì•„ì£¼ì„¸?? ?°ì´??ì¤€ë¹? ë§Œë‚¨, ?°ì´??ì½”ìŠ¤, ?˜ë§Œ???€?”ë? ê°ì„±?ìœ¼ë¡??œí˜„?˜ì„¸??",
        ?”ë¦¬: "?”ë¦¬ ê³¼ì •ê³??„ì„±ê¹Œì?ë¥?ë³´ì—¬ì£¼ì„¸?? ?ˆì‹œ???Œê°œ, ì¡°ë¦¬ ê³¼ì •, ?Œë ˆ?´íŒ…, ?œì‹ ë¦¬ì•¡?˜ì„ ?ì—°?¤ëŸ½ê²??´ì•„ì£¼ì„¸??",
      };

      const specificVlogPrompt =
        vlogTypePrompts[vlogType || "?¼ìƒ"] || vlogTypePrompts["?¼ìƒ"];

      contents = `"${newKeyword}"ë¥?ì£¼ì œë¡???"${
        vlogType || "?¼ìƒ"
      }" ?€?…ì˜ ?„ì „???ˆë¡œ??ë¸Œì´ë¡œê·¸ë¥?ê¸°íš?´ì£¼?¸ìš”. ëª©í‘œ ?ìƒ ê¸¸ì´????${length}?…ë‹ˆ??${lengthGuideline}

**?ˆë? ê·œì¹™:**
- ?„ë˜ ?œê³µ??ë¶„ì„ ?ë£Œ??**?€ë³?êµ¬ì¡°(?¨ê³„ë³??ë¦„)**ë§?ì°¸ê³ ?˜ì„¸??- ?ë³¸ ë¸Œì´ë¡œê·¸???¥ë©´, ?í™©, ?€?¬ëŠ” ?ˆë? ?¬ìš©?˜ì? ë§ˆì„¸??- "${newKeyword}"ë¥?ì¤‘ì‹¬?¼ë¡œ ?„ì „???ˆë¡œ???¥ë©´ê³??í™©??ì°½ì‘?˜ì„¸??
**${vlogType || "?¼ìƒ"} ë¸Œì´ë¡œê·¸ ?¹í™” ê°€?´ë“œ:**
${specificVlogPrompt}

**ê³µí†µ ë¸Œì´ë¡œê·¸ ?”ì†Œ:**
- ?ì—°?¤ëŸ¬???ë¦„ê³?ì¹œê·¼???¤ì•¤ë§¤ë„ˆ
- ?œì²­?ì???ê³µê°?€ ?•ì„± (TMI, ?”ì§???´ì•¼ê¸?
- ?¸ì§‘ ë¦¬ë“¬: ë¹ ë¥¸ ì»??„í™˜ê³?ê°ì„±?ì¸ BGM
- ?œê°??ë¯¸í•™: ?ì—°ê´? ê°ì„±?ì¸ ?‰ê°, ?¼ìƒ???„ë¦„?¤ì? ?¬ì°©
- ?¸ë„¤?? ?ì—°?¤ëŸ½ê³?ê³µê° ê°€???œê°„

**êµ¬ì„± ?ë¦„:**
1. ?¸íŠ¸ë¡? ?¤ëŠ˜??ë¸Œì´ë¡œê·¸ ?Œê°œ
2. ë©”ì¸ ì»¨í…ì¸? ${vlogType || "?¼ìƒ"}??ë§ëŠ” ?ì—°?¤ëŸ¬???„ê°œ
3. ?˜ì´?¼ì´?? ?¹ë³„???œê°„/?¬ì¸??4. TMI: ê°œì¸?ì¸ ?ê°ê³?ê°ì • ê³µìœ 
5. ?„ì›ƒ?¸ë¡œ: ë§ˆë¬´ë¦¬ì? ?¤ìŒ ?ìƒ ?ˆê³ 

ê°??¥ë©´ë§ˆë‹¤ êµ¬ì²´?ì¸ ì´¬ì˜ ê°€?´ë“œ?€ ?¸ì§‘ ?¬ì¸?¸ë? ?¬í•¨?´ì£¼?¸ìš”.

**?´ë?ì§€ ?„ë¡¬?„íŠ¸ ?‘ì„± ê°€?´ë“œ - ë¸Œì´ë¡œê·¸ ?¤í???*:
ê¸°ë³¸ ?¤ì›Œ?? candid photo, vlog style, natural lighting, realistic, friendly, warm color palette

?˜ìœ„ ?€?…ë³„ ì¶”ê? ?¤ì›Œ??
- ëª¨ë‹ ë£¨í‹´: soft morning light, cozy, peaceful, serene, waking up scene, warm tones
- ?¤ì´?´íŠ¸: healthy food, fitness, energetic, fresh ingredients, bright and clean
- ?¬í–‰: beautiful landscape, wide angle shot, adventurous, vibrant colors, travel photography
- ?¸ë°•?? unboxing, product focused, clean background, detailed shot, excitement
- ?¨ì…˜: fashion style, full body shot, street style photography, stylish outfit, confident pose
- ê³µë?: study with me, desk setup, focused, calm, lofi mood, cozy lighting
- ?´ë™: dynamic action shot, fitness, workout, powerful, energetic, gym setting
- ?¼ìƒ: slice of life, candid moment, authentic, simple, everyday scene
- ?°ì´?? romantic, lovely couple, warm sunset light, happy moment, soft focus
- ?”ë¦¬: home cooking, cozy kitchen, bright natural light, simple and delicious food

?ˆì‹œ: "candid vlog style photo of a person waking up, soft morning light, cozy bedroom, peaceful and serene, warm tones, natural realistic style"

**ì°¸ê³ ???€ë³?êµ¬ì¡° (êµ¬ì¡°ë§?ì°¨ìš©, ?´ìš©?€ ?ˆë? ?¬ìš© ê¸ˆì?):**

${analysisString}

??êµ¬ì¡°???ë¦„ë§?ì°¸ê³ ?˜ì—¬, "${newKeyword}"ë¥?ì£¼ì œë¡??„ì „???ˆë¡œ??ë¸Œì´ë¡œê·¸ ?¥ë©´ê³??€?¬ë? ì°½ì‘?´ì£¼?¸ìš”. ëª¨ë“  ê²°ê³¼ ??ª©??ì§€?•ëœ êµ¬ì¡°??ë§ì¶° JSON ?•ì‹?¼ë¡œ ?œê³µ?´ì£¼?¸ìš”.`;
    } else if (isMukbangChannel) {
      contents = `"${newKeyword}" ?Œì‹?¼ë¡œ ?„ì „???ˆë¡œ??ë¨¹ë°© ?ìƒ ê¸°íš?ˆì„ ë§Œë“¤??ì£¼ì„¸?? ëª©í‘œ ?ìƒ ê¸¸ì´????${length}?…ë‹ˆ??${lengthGuideline}

**?ˆë? ê·œì¹™:**
- ?„ë˜ ?œê³µ??ë¶„ì„ ?ë£Œ??**?€ë³?êµ¬ì¡°(?¨ê³„ë³??ë¦„)**ë§?ì°¸ê³ ?˜ì„¸??- ?ë³¸ ë¨¹ë°©???¥ë©´, ?€?? ë¦¬ì•¡?˜ì? ?ˆë? ?¬ìš©?˜ì? ë§ˆì„¸??- "${newKeyword}"ë¥?ì¤‘ì‹¬?¼ë¡œ ?„ì „???ˆë¡œ???¥ë©´ê³?ë¦¬ì•¡?˜ì„ ì°½ì‘?˜ì„¸??
**ë¨¹ë°© ì½˜í…ì¸?ê°€?´ë“œ:**
- ?Œì‹??ë¨¹ëŠ” ê³¼ì •??ì¤‘ì‹¬?¼ë¡œ, ë§?ë¦¬ì•¡?˜ê³¼ ?Œì‹ ?Œê°œë¥??ì—°?¤ëŸ½ê²??´ì•„ì£¼ì„¸??- ASMR ?”ì†Œ: ?¹ëŠ” ?Œë¦¬, ì¡°ë¦¬ ?Œë¦¬ ??ì²?°??ë§Œì¡±ê°?- ?Œì‹ ?”í…Œ?? ?´ë¡œì¦ˆì—… ?·ìœ¼ë¡?ë¹„ì£¼??ê°•ì¡°
- ì¡°ë¦¬ ê³¼ì •: ?”ë¦¬?˜ëŠ” ê²½ìš° ê°„ë‹¨???ˆì‹œ???Œê°œ
- ?”ì§??ë¦¬ì•¡?? ë§? ?ê°, ?¨ë„ ?±ì— ?€???ì—°?¤ëŸ¬??ë°˜ì‘

**êµ¬ì„± ?”ì†Œ:**
1. ?¸íŠ¸ë¡? ?¤ëŠ˜??ë©”ë‰´ ?Œê°œ ë°?ê¸°ë?ê°?ì¡°ì„±
2. ?Œì‹ ì¤€ë¹? êµ¬ë§¤ ê³¼ì • ?ëŠ” ì¡°ë¦¬ ê³¼ì • (? íƒ)
3. ì²???ë¦¬ì•¡?? ì²?ë§›ì˜ ?”ì§???ë‚Œ
4. ë³¸ê²© ë¨¹ë°©: ?¤ì–‘???µê?ê³?ASMR
5. ì´í‰: ?Œì‹???€??ì¢…í•© ?‰ê? ë°?ì¶”ì²œ

ê°??¥ë©´ë§ˆë‹¤ ì´¬ì˜ ?ê³¼ ?¸ì§‘ ?¬ì¸?¸ë? ?¬í•¨?´ì£¼?¸ìš”.

**?´ë?ì§€ ?„ë¡¬?„íŠ¸ ?‘ì„± ê°€?´ë“œ - ë¨¹ë°© ?¤í???*:
- ?µì‹¬ ?¤ì›Œ?? extreme close-up on food, delicious, mouth-watering, vibrant, dynamic eating shot
- ?Œì‹??ê·¹ë‹¨?ìœ¼ë¡??´ë¡œì¦ˆì—…?˜ì—¬ ë§›ìˆ??ë³´ì´??ì§ˆê°ê³??‰ê° ê·¹ë???- ASMR ?”ì†Œë¥??œê°?ìœ¼ë¡??œí˜„
- ?ˆì‹œ: "extreme close-up of delicious Korean fried chicken, mouth-watering, vibrant colors, steam rising, highly detailed food texture, appetizing presentation"

**ì°¸ê³ ???€ë³?êµ¬ì¡° (êµ¬ì¡°ë§?ì°¨ìš©, ?´ìš©?€ ?ˆë? ?¬ìš© ê¸ˆì?):**

${analysisString}

??êµ¬ì¡°???ë¦„ë§?ì°¸ê³ ?˜ì—¬, "${newKeyword}"ë¥?ì£¼ì œë¡??„ì „???ˆë¡œ??ë¨¹ë°© ?¥ë©´ê³?ë¦¬ì•¡?˜ì„ ì°½ì‘?´ì£¼?¸ìš”. ëª¨ë“  ê²°ê³¼ ??ª©??ì§€?•ëœ êµ¬ì¡°??ë§ì¶° JSON ?•ì‹?¼ë¡œ ?œê³µ?´ì£¼?¸ìš”.`;
    } else if (category === "?¼í•‘ ë¦¬ë·°") {
      contents = `"${newKeyword}" ?œí’ˆ???€???„ì „???ˆë¡œ??ë¦¬ë·° ?ìƒ ê¸°íš?ˆì„ ë§Œë“¤??ì£¼ì„¸?? ëª©í‘œ ?ìƒ ê¸¸ì´????${length}?…ë‹ˆ??${lengthGuideline}

**?ˆë? ê·œì¹™:**
- ?„ë˜ ?œê³µ??ë¶„ì„ ?ë£Œ??**?€ë³?êµ¬ì¡°(?¨ê³„ë³??ë¦„)**ë§?ì°¸ê³ ?˜ì„¸??- ?ë³¸ ë¦¬ë·°???œí’ˆ ?•ë³´, ?‰ê? ?´ìš©, ?€?¬ëŠ” ?ˆë? ?¬ìš©?˜ì? ë§ˆì„¸??- "${newKeyword}" ?œí’ˆ???¹ì„±??ë§ëŠ” ?„ì „???ˆë¡œ??ë¦¬ë·° ?´ìš©??ì°½ì‘?˜ì„¸??
?ìƒ?€ '?¤í”„??, '?œí’ˆ ?Œê°œ', 'ì£¼ìš” ?¹ì§• ?œì—°', '?¥ë‹¨??ë¶„ì„', 'ì´í‰ ë°?ì¶”ì²œ'?¼ë¡œ êµ¬ì„±?˜ì–´???©ë‹ˆ?? ??êµ¬ì¡°??ë§ì¶° ê°??¨ê³„ë³??œëª©, ëª©ì , ?ì„¸ ?´ìš©???¬í•¨??êµ¬ì¡°?ì¸ ê°œìš”ë¥??‘ì„±?´ì£¼?¸ìš”.

**?´ë?ì§€ ?„ë¡¬?„íŠ¸ ?‘ì„± ê°€?´ë“œ - ?¼í•‘ ë¦¬ë·° ?¤í???*:
- ?µì‹¬ ?¤ì›Œ?? product shot, studio lighting, clean background, macro shot, detailed texture
- ?œí’ˆ???”í…Œ?¼ê³¼ ì§ˆê°????ë³´ì´?„ë¡ ?¤íŠœ?”ì˜¤ ì¡°ëª…ê³?ê¹”ë”??ë°°ê²½ ?œìš©
- ?‘ì‚¬ êµ¬ë„ë¡??œí’ˆ ?¹ì§• ê°•ì¡°
- ?ˆì‹œ: "product photography of wireless earbuds, studio lighting, white clean background, macro detailed shot, sleek design, high quality texture, 8K"

**ì°¸ê³ ???€ë³?êµ¬ì¡° (êµ¬ì¡°ë§?ì°¨ìš©, ?´ìš©?€ ?ˆë? ?¬ìš© ê¸ˆì?):**

${analysisString}

??êµ¬ì¡°???ë¦„ë§?ì°¸ê³ ?˜ì—¬, "${newKeyword}"ë¥?ì£¼ì œë¡??„ì „???ˆë¡œ??ë¦¬ë·° ?´ìš©??ì°½ì‘?´ì£¼?¸ìš”. ëª¨ë“  ê²°ê³¼ ??ª©??ì§€?•ëœ êµ¬ì¡°??ë§ì¶° JSON ?•ì‹?¼ë¡œ ?œê³µ?´ì£¼?¸ìš”.`;
    } else if (category === "49ê¸?) {
      contents = `?±ì¸ ?€?ì˜ ?±ìˆ™???°ì• /ê´€ê³??´ì•¼ê¸?"${newKeyword}")ë¥??¤ë£¨???ìƒ ê¸°íš?ˆì„ ë§Œë“¤??ì£¼ì„¸?? ëª©í‘œ ?ìƒ ê¸¸ì´????${length}?…ë‹ˆ??${lengthGuideline}

**ì¤‘ìš”: ì½˜í…ì¸?ê°€?´ë“œ?¼ì¸**
- ? ì •?ì´ê±°ë‚˜ ?¸ê³¨?ì¸ ?œí˜„?€ ?ˆë? ?¬ìš©?˜ì? ë§ˆì„¸??- ?±ì¸?¤ì˜ ?”ì§?˜ê³  ?„ì‹¤?ì¸ ?°ì•  ê³ ë?, ê´€ê³?ê²½í—˜?´ì— ì´ˆì 
- ? ë¨¸?¬ìŠ¤?˜ë©´?œë„ ?ˆìœ„ ?ˆëŠ” ?¤í† ë¦¬í…”ë§?- ê³µê°ê³??„ë¡œë¥?ì¤????ˆëŠ” ?°ëœ»????- êµí›ˆ?´ë‚˜ ?¸ì‚¬?´íŠ¸ë¥??´ì•„ ?˜ë? ?ˆëŠ” ?´ìš©?¼ë¡œ êµ¬ì„±

**ì½˜í…ì¸?ë°©í–¥:**
- ?°ì•  ì´ˆê¸°???¤ë ˜ê³?ê³ ë? (?? ?¸ê°, ì²?ë§Œë‚¨)
- ê´€ê³„ì—??ê²ªëŠ” ?„ì‹¤?ì¸ ë¬¸ì œ?€ ?´ê²° (?¤íˆ¼, ?¤í•´, ?”í•´)
- ?´ë³„ê³??±ì¥ ?´ì•¼ê¸?(ê·¹ë³µ, êµí›ˆ, ?ˆë¡œ???œì‘)
- ?°ì•  ?¬ë¦¬?€ ?¨í„´ ë¶„ì„ (MBTI, ?°ì•  ?¤í???
- ê±´ê°•??ê´€ê³„ë? ?„í•œ ?Œí†µê³??´í•´

**?¤í† ë¦¬í…”ë§?êµ¬ì¡°:**
1. ?„í¬: ê³µê° ê°€???í™© ?œì‹œ
2. ?„ê°œ: ?±ì¥?¸ë¬¼???¬ë¦¬?€ ?‰ë™ ë¬˜ì‚¬
3. ê°ˆë“±: ê´€ê³„ì—?œì˜ ?„ì‹¤?ì¸ ë¬¸ì œ
4. ?´ê²°/?¸ì‚¬?´íŠ¸: ë°°ìš¸ ?ì´??êµí›ˆ
5. ë§ˆë¬´ë¦? ?œì²­?ì—ê²??„ë¡œ?€ ?‘ì› ë©”ì‹œì§€

**ë°°ì—­ êµ¬ì„±:**
- '??, '?ë?ë°?, 'ì¹œêµ¬' ???ì—°?¤ëŸ¬???€?”í˜• êµ¬ì„±
- ê°?ë°°ì—­???¬ë¦¬?€ ê°ì •? ì„ ?¬ì„¸?˜ê²Œ ?œí˜„
- ?„ì‹¤?ì´ê³?ê³µê° ê°€???€?¬ì? ?í™© ?°ì¶œ

**?´ë?ì§€ ?„ë¡¬?„íŠ¸ ?‘ì„± ê°€?´ë“œ - 49ê¸?(?°ì•  ?¤í† ë¦? ?¤í???*:
- ?µì‹¬ ?¤ì›Œ?? intimate, sensual, moody, low-key lighting, suggestive, romantic atmosphere
- ?€ë°€?˜ê³  ê°ê°?ì¸ ë¶„ìœ„ê¸°ë? ?„í•´ ?´ë‘¡ê³?ë¶€?œëŸ¬??ì¡°ëª…ê³?ë¡œë§¨?±í•œ ë¬´ë“œ ê°•ì¡°
- ê°ì •ê³??¬ë¦¬ ?íƒœ ì¤‘ì‹¬, ? ì •???”ì†Œ ë°°ì œ
- ?ˆì‹œ: "intimate scene of two people talking closely, moody lighting, romantic atmosphere, soft focus, emotional connection, low-key photography, suggestive but tasteful"

ëª¨ë“  ?´ìš©?€ ê±´ì „?˜ê³  êµìœ¡?ì¸ ê°€ì¹˜ë? ì§€?ˆë©°, ?Œë«??ê°€?´ë“œ?¼ì¸??100% ì¤€?˜í•´???©ë‹ˆ??

?±ê³µ?ì¸ ?™ì˜??ë¶„ì„ ?´ìš©:\n\n${analysisString}\n\n?´ì œ ??ë¶„ì„???±ê³µ êµ¬ì¡°ë¥??°ë¥´???ˆë¡œ???¤ì›Œ??"${newKeyword}"??ì´ˆì ??ë§ì¶˜ ?„ì „???ˆë¡œ??ê¸°íš?ˆì„ ?ì„±?´ì£¼?¸ìš”. ?ë³¸ ?€ë³¸ì˜ ?´ìš©???¬ìš©?˜ì? ë§ê³ , ?ˆë¡œ???¤í† ë¦¬ì? ?€?¬ë? ì°½ì‘?´ì£¼?¸ìš”. ëª¨ë“  ê²°ê³¼ ??ª©??ì§€?•ëœ êµ¬ì¡°??ë§ì¶° JSON ?•ì‹?¼ë¡œ ?œê³µ?´ì£¼?¸ìš”.`;
    } else if (isYadamChannel) {
      contents = `ì¡°ì„ ?œë?ë¥?ë°°ê²½?¼ë¡œ ???„í†µ ?¼ë‹´ ?´ì•¼ê¸?"${newKeyword}")ë¥??„ë??ìœ¼ë¡??¬í•´?í•œ ?ìƒ ê¸°íš?ˆì„ ë§Œë“¤??ì£¼ì„¸?? ëª©í‘œ ?ìƒ ê¸¸ì´????${length}?…ë‹ˆ??

**ì¤‘ìš”: ?¼ë‹´ ì½˜í…ì¸?ê°€?´ë“œ?¼ì¸**
- ?¼ë‹´?€ ì¡°ì„ ?œë???ë¯¼ê°„ ?¤í™”, ê¸°ë¡, ?¼í™” ?±ì„ ?¤ë£¨???„í†µ ?¤í† ë¦¬í…”ë§ì…?ˆë‹¤
- ??‚¬??ê³ ì¦ê³??„ë????¬ë?ë¥?ê· í˜•?ˆê²Œ ë°°ì¹˜
- êµí›ˆ?ì´ê±°ë‚˜ ?¥ë?ë¡œìš´ ?´ì•¼ê¸°ë? ?µí•´ ??? ì¡°?¤ì˜ ì§€???„ë‹¬
- ?œêµ­ ?„í†µ ë¬¸í™”?€ ?•ì„œë¥??ì—°?¤ëŸ½ê²??¹ì—¬?´ê¸°

**ì½˜í…ì¸??Œì¬:**
- ì¡°ì„ ?œë? ?¤ì œ ?¸ë¬¼?¤ì˜ ?¼í™” (?™ì, ê´€ë¦? ? ë¹„, ê¸°ìƒ ??
- ?„í†µ ?¤í™”?€ ë¯¼ë‹´ (?„ê¹¨ë¹? êµ¬ë??? ?€?¹ì‚¬????
- ?˜ì , ?‘ê° ?´ì•¼ê¸?- ì¡°ì„ ?œë? ë¯¸ìŠ¤?°ë¦¬?€ ?¬ê±´??- ê¶ì¤‘ ?¼ì‚¬?€ ??‚¬???·ì´?¼ê¸°
- ?‘ë°˜ê³??‰ë????? ?¬íšŒ ?ì

**?¤í† ë¦¬í…”ë§?êµ¬ì¡°:**
1. ë°°ê²½ ?Œê°œ: ?œë???ë°°ê²½ê³??í™© ?¤ëª…
2. ?¬ê±´ ë°œë‹¨: ?´ì•¼ê¸°ì˜ ?œì‘ê³?ì£¼ìš” ?¸ë¬¼ ?±ì¥
3. ?„ê°œ: ê°ˆë“±ê³??¬ê±´???„ê°œ
4. ?ˆì •: ?´ì•¼ê¸°ì˜ ?˜ì´?¼ì´??5. ê²°ë§ê³?êµí›ˆ: ?´ì•¼ê¸°ì˜ ë§ˆë¬´ë¦¬ì? ?„ë????˜ë?

**ë°°ì—­ êµ¬ì„±:**
- ì¡°ì„ ?œë? ?¸ë¬¼?? ?‘ë°˜, ? ë¹„, ?¬ë˜, ?¬ì¡¸, ?ì¸, ê¸°ìƒ, ë¬´ë‹¹ ??- ?˜ë ˆ?´í„°: ?´ì•¼ê¸°ë? ?€?´ê????„í†µ?ì¸ ?´ì•¼ê¸°ê¾¼ ??- ê°?ë°°ì—­??? ë¶„ê³??œë????¹ì„±??ë°˜ì˜??ë§íˆ¬?€ ?‰ë™

**?°ì¶œ ?¬ì¸??**
- ?œêµ­ ?„í†µ ?Œì•…(êµ?•…) ?œìš©
- ?œë³µ, ?„í†µ ê°€?????œë???ë°˜ì˜
- ?œì˜ˆ, ?œì‹œ ???„í†µ ë¬¸í™” ?”ì†Œ ?½ì…
- ?„ë??¸ì´ ?´í•´?˜ê¸° ?½ë„ë¡??ì ˆ???¤ëª… ì¶”ê?

ê°??€?¬ë§ˆ??ì¡°ì„ ?œë? ë¶„ìœ„ê¸°ë? ?´ë¦° ?´ë?ì§€ ?ì„± ?„ë¡¬?„íŠ¸('imagePrompt')ë¥?ë°˜ë“œ???¬í•¨?´ì•¼ ?©ë‹ˆ??

**?´ë?ì§€ ?„ë¡¬?„íŠ¸ ?‘ì„± ê°€?´ë“œ - ?¼ë‹´ (ì¡°ì„ ?œë?) ?¤í???*:
- ?µì‹¬ ?¤ì›Œ?? traditional Korean painting style, folklore, mysterious night, moonlight, ancient, historical illustration
- ?œêµ­ ?„í†µ ë¯¼ë‹´ ?ë‚Œ???´ë¦¬ê¸??„í•´ ?„í†µ ?Œí™” ?¤í??? ?¬ë¹›, ê³ ì „???”ì†Œ ?¬ìš©
- ?œë³µ, ?œì˜¥, ?„í†µ ?Œí’ˆ ?±ì„ êµ¬ì²´?ìœ¼ë¡?ë¬˜ì‚¬
- ?ˆì‹œ: "traditional Korean painting style of a scholar in hanbok under moonlight, ancient Joseon era, mysterious atmosphere, historical illustration, folklore art style"

?±ê³µ?ì¸ ?™ì˜??ë¶„ì„ ?´ìš©:\n\n${analysisString}\n\n?´ì œ ??ë¶„ì„???±ê³µ êµ¬ì¡°ë¥??°ë¥´???ˆë¡œ???¤ì›Œ??"${newKeyword}"??ì´ˆì ??ë§ì¶˜ ?„ì „???ˆë¡œ??ì¡°ì„ ?œë? ?¼ë‹´ ?´ì•¼ê¸°ë? ì°½ì‘?´ì£¼?¸ìš”. ?ë³¸ ?€ë³¸ì˜ ?´ìš©?´ë‚˜ ?¤í† ë¦¬ë? ?¬ìš©?˜ì? ë§ê³ , ?ˆë¡œ???¸ë¬¼ê³??¬ê±´?¼ë¡œ êµ¬ì„±???…ì°½?ì¸ ?¼ë‹´??ë§Œë“¤?´ì£¼?¸ìš”. ëª¨ë“  ê²°ê³¼ ??ª©??ì§€?•ëœ êµ¬ì¡°??ë§ì¶° JSON ?•ì‹?¼ë¡œ ?œê³µ?´ì£¼?¸ìš”.`;
    } else if (isGukppongChannel) {
      contents = `?œêµ­???°ìˆ˜?±ê³¼ ?¸ê³„ ?ì—?œì˜ ?„ìƒ??ì£¼ì œë¡???êµ?½• ì½˜í…ì¸?"${newKeyword}")ë¥?ê¸°íš??ì£¼ì„¸?? ëª©í‘œ ?ìƒ ê¸¸ì´????${length}?…ë‹ˆ??${lengthGuideline}

**ì¤‘ìš”: êµ?½• ì½˜í…ì¸?ê°€?´ë“œ?¼ì¸**

êµ?½• ì½˜í…ì¸ ëŠ” ?œêµ­???±ì·¨?€ ?°ìˆ˜?±ì„ ê°•ì¡°?˜ì—¬ ?œì²­?ì—ê²?ë¯¼ì¡±???ê¸?¬ê³¼ ê°ì •??ë§Œì¡±???œê³µ?˜ëŠ” ì½˜í…ì¸ ì…?ˆë‹¤.

**?µì‹¬ ?Œë§ˆ:**
1. **êµ?????°ì›”??ê°•ì¡°**
   - "?œêµ­???¸ê³„ë¥??€?¼ê²Œ ?ˆë‹¤"
   - "?¤ë¥¸ ?˜ë¼?¤ì´ ?°ë¼?????†ëŠ” ?œêµ­ë§Œì˜ ê²?
   - "?¸ê³„ê°€ ?¸ì •??K-OOO"
   
2. **ë¹„êµë¥??µí•œ ?°ì›”???…ì¦**
   - "?¼ë³¸?€ ëª»í•˜?”ë° ?œêµ­?€ ?´ëƒˆ??
   - "ë¯¸êµ­??ë°°ìš°???¤ëŠ” ?œêµ­??OOO"
   - "ì¤‘êµ­???°ë¼?˜ë ¤???¤íŒ¨???œêµ­ ê¸°ìˆ "
   
3. **?¸êµ­??ë°˜ì‘ ì¤‘ì‹¬**
   - "?¸êµ­?¸ë“¤??ì¶©ê²©ë°›ì? ?œêµ­??OOO"
   - "?´ì™¸?ì„œ ?œë¦¬??K-OOO"
   - "?¸êµ­?¸ë“¤???¸ì •???œêµ­ ë¬¸í™”"

**?¬ë¦¬??ë©”ì»¤?ˆì¦˜:**
- ì§‘ë‹¨ ?•ì²´??ê°•í™”: "?°ë¦¬ ?œêµ­?¸ì? ?¹ë³„?˜ë‹¤"???Œì†ê°?- ?•ì¦ ?¸í–¥ ?œìš©: ?œêµ­??ê¸ì •?ì¸ ë©´ë§Œ ? ë³„?ìœ¼ë¡??œì‹œ
- ê°ì •??ì¹´í?ë¥´ì‹œ?? ?ë‘?¤ëŸ¬?€, ë¿Œë“¯?? ?°ì›”ê°??œê³µ
- ë°©ì–´ ê¸°ì œ: ??‚¬???„í””?´ë‚˜ ?„ì¬??ë¬¸ì œë¥??±ì·¨ë¡??ì‡„

**ì½˜í…ì¸?êµ¬ì„± ?¨í„´:**
1. **ì¶©ê²©?ì¸ ?„ì…ë¶€**
   - "?¸êµ­?¸ë“¤???œêµ­???€??ê°€???€?€ ê²ƒì??"
   - "?¼ë³¸ ?„ë¬¸ê°€???¸ì •???œêµ­??ì§„ì§œ ?¤ë ¥"
   - "?¸ê³„ê°€ ?œêµ­??ë³´ëŠ” ì§„ì§œ ?´ìœ "

2. **ê³¼ì¥???€?´í?ê³??¸ë„¤??*
   - "?¸ê³„ 1??, "ì¶©ê²©", "ê²½ì•…", "?œë¦¬"
   - ?¸êµ­?¸ì˜ ?€?€ ?œì • ?´ë?ì§€
   - ?œêµ­ vs ?€êµ?ë¹„êµ ê·¸ë˜??
3. **? ë³„???•ë³´ ?œì‹œ**
   - ?œêµ­???±ê³µ ?¬ë?ë§?ì§‘ì¤‘ ì¡°ëª…
   - ?µê³„???œìœ„??? ë¦¬??ë¶€ë¶„ë§Œ ë°œì·Œ
   - ë§¥ë½ ?†ëŠ” ?¸êµ­??ì¹?°¬ ?ìƒ ?¸ì§‘

4. **ê°ì •???Œì•…ê³??°ì¶œ**
   - ?…ì¥??ë°°ê²½?Œì•…
   - ? êµ­ê°€???œêµ­ ?„í†µ ?Œì•… ?œìš©
   - ?œê·¹ê¸? ?œêµ­ ?œë“œë§ˆí¬ ?´ë?ì§€

5. **? êµ­??ê²°ë¡ **
   - "?œêµ­?¸ì´???ë‘?¤ëŸ½??
   - "?°ë¦¬ê°€ ëª°ë???œêµ­??ì§„ì§œ ?„ìƒ"
   - "?¸ê³„ê°€ ë¶€?¬ì›Œ?˜ëŠ” ?€?œë?êµ?

**ì£¼ìš” ?Œì¬ ?ˆì‹œ:**
- K-POP, K-?œë¼ë§ˆì˜ ?¸ê³„???±ê³µ
- ?œêµ­ IT ê¸°ìˆ  (ë°˜ë„ì²? ?¤ë§ˆ?¸í°, ?¸í„°???ë„)
- ?œì‹???¸ê³„??(ê¹€ì¹? ë¹„ë¹”ë°? ?œêµ­ BBQ)
- ?œêµ­??ê²½ì œ ?±ì¥ (?œê°•??ê¸°ì )
- ?œêµ­ ?¤í¬ì¸??¤í??¤ì˜ ?œì•½
- ?œêµ­ ??‚¬???ë‘?¤ëŸ¬???œê°„??- ?¸êµ­?¸ë“¤???€?¼ëŠ” ?œêµ­ ë¬¸í™” (ë°°ë‹¬ ?œìŠ¤?? ?¸ì˜?? ?€ì¤‘êµ??
- ?œêµ­??êµìœ¡?´ê³¼ ?±ì·¨
- K-ë°©ì—­, K-ë·°í‹° ??? ì¡°?´ë¡œ ?œí˜„?˜ëŠ” ?œêµ­???œìŠ¤??
**ë°°ì—­ êµ¬ì„±:**
- ?˜ë ˆ?´í„°: ?ë????˜ì¹˜???¤ìœ¼ë¡??œêµ­???°ìˆ˜??ê°•ì¡°
- ?¸êµ­??ë°˜ì‘?? ê°íƒ„?˜ê³  ?€?¼ëŠ” ë¦¬ì•¡???œí˜„
- ?„ë¬¸ê°€: ?œêµ­???±ì·¨ë¥?ê°ê??ìœ¼ë¡??) ?¸ì¦?˜ëŠ” ??• 
- ?œêµ­???¹ì‚¬?? ê²¸ì†?˜ì?ë§??ë‘?¤ëŸ¬???œë„

**?€?´í? ?ˆì‹œ:**
- "?¼ë³¸?¸ë„ ì¶©ê²©ë°›ì? ?œêµ­??ì§„ì§œ ê¸°ìˆ ??
- "ë¯¸êµ­?¸ë“¤???œêµ­???€??ê°€??ë¶€?¬ì›Œ??ê²?
- "?¸êµ­?¸ë“¤???¸ì •???œêµ­???¸ê³„ ìµœê³ ???´ìœ "
- "ì¤‘êµ­???ˆë? ëª??°ë¼?˜ëŠ” ?œêµ­ë§Œì˜ ë¹„ë?"
- "?¸ê³„ê°€ ?œêµ­??ë³´ëŠ” ì§„ì§œ ?œì„  (?¸êµ­??ë°˜ì‘)"
- "? ëŸ½?¸ë“¤???œêµ­ ë¬¸í™”???´ê´‘?˜ëŠ” ?´ìœ "
- "?œêµ­?¸ë„ ëª°ë???¸ê³„ ???€?œë?êµ?˜ ?„ìƒ"

**ì£¼ì˜?¬í•­:**
- ê³¼ë„??ë¹„í•˜???ì˜¤ ?œí˜„?€ ì§€??(ê±´ì „???ë???? ì?)
- ?©íŠ¸ ì²´í¬???•ë³´ ê¸°ë°˜ (ê³¼ì¥?€ OK, ê±°ì§“?€ NO)
- ?€êµ?— ?€??ì§ì ‘?ì¸ ë¹„ë‚œë³´ë‹¤???œêµ­???°ìˆ˜??ê°•ì¡°
- ê°ì •??ê³µê°?€ ?•ì„±??ì§‘ì¤‘

ê°??€?¬ë§ˆ???œêµ­???°ìˆ˜?±ì„ ?œê°?ìœ¼ë¡?ë³´ì—¬ì£¼ëŠ” ?´ë?ì§€ ?ì„± ?„ë¡¬?„íŠ¸('imagePrompt')ë¥?ë°˜ë“œ???¬í•¨?´ì•¼ ?©ë‹ˆ??

**?´ë?ì§€ ?„ë¡¬?„íŠ¸ ?‘ì„± ê°€?´ë“œ - êµ?½• ?¤í???*:
- ?µì‹¬ ?¤ì›Œ?? epic, grand scale, patriotic, dynamic, inspiring, vibrant national symbols
- ?…ì¥?˜ê³  ?ê°??ì£¼ëŠ” ë¶„ìœ„ê¸°ë? ?„í•´ ??™?ì¸ êµ¬ë„?€ ?ì§•???”ì†Œë¥??”ë ¤?˜ê²Œ ?œí˜„
- ?œêµ­???ì§•???”ì†Œ ê°•ì¡° (?œê?, ?œê·¹ê¸? ?œë³µ, ?„ë? ê±´ì¶•ë¬? K-pop, ?œì‹ ??
- ?ˆì‹œ: "epic scene of Seoul city skyline at night with Namsan Tower, grand scale, vibrant neon lights, patriotic, inspiring atmosphere, dynamic composition, highly detailed, cinematic"

**ì°¸ê³ ???€ë³?êµ¬ì¡° (êµ¬ì¡°ë§?ì°¨ìš©, ?´ìš©?€ ?ˆë? ?¬ìš© ê¸ˆì?):**

${analysisString}

??êµ¬ì¡°???ë¦„ë§?ì°¸ê³ ?˜ì—¬, "${newKeyword}"ë¥?ì£¼ì œë¡??„ì „???ˆë¡œ??êµ?½• ?¤í† ë¦¬ì? ?€?¬ë? ì°½ì‘?´ì£¼?¸ìš”. ?ë³¸ ?€ë³¸ì˜ ?¬ë????´ìš©?€ ?¬ìš©?˜ì? ë§ˆì„¸?? ëª¨ë“  ê²°ê³¼ ??ª©??ì§€?•ëœ êµ¬ì¡°??ë§ì¶° JSON ?•ì‹?¼ë¡œ ?œê³µ?´ì£¼?¸ìš”.`;
    } else if (isNorthKoreaChannel) {
      contents = `ë¶í•œ ê´€???´ìŠˆ?€ ?ˆë¶ë¯??´ì•¼ê¸?"${newKeyword}")ë¥??¤ë£¨???ìƒ ê¸°íš?ˆì„ ë§Œë“¤??ì£¼ì„¸?? ëª©í‘œ ?ìƒ ê¸¸ì´????${length}?…ë‹ˆ??${lengthGuideline}

**?ˆë? ê·œì¹™:**
- ?„ë˜ ?œê³µ??ë¶„ì„ ?ë£Œ??**?€ë³?êµ¬ì¡°(?¨ê³„ë³??ë¦„)**ë§?ì°¸ê³ ?˜ì„¸??- ?ë³¸ ?ìƒ???±ì¥?¸ë¬¼, ?í™©, ë°°ê²½, ?€?¬ëŠ” ?ˆë? ?¬ìš©?˜ì? ë§ˆì„¸??- "${newKeyword}"ë¥?ì¤‘ì‹¬?¼ë¡œ ?„ì „???ˆë¡œ???¸ë¬¼, ?í™©, ?¤í† ë¦¬ë? ì°½ì‘?˜ì„¸??
**ì¤‘ìš”: ë¶í•œ ?´ìŠˆ ì½˜í…ì¸?ê°€?´ë“œ?¼ì¸**

ë¶í•œ ?´ìŠˆ ì½˜í…ì¸ ëŠ” ë¶í•œ???¤ìƒê³??ˆë¶ë¯¼ì˜ ê²½í—˜?´ì„ ì§„ì??˜ë©´?œë„ ?¥ë?ë¡?²Œ ?¤ë£¨??ì½˜í…ì¸ ì…?ˆë‹¤.

**?µì‹¬ ?Œë§ˆ:**
1. **?ˆë¶ë¯¼ì˜ ?ìƒ??ì¦ì–¸**
   - ë¶í•œ?ì„œ???¤ì œ ?í™œ ê²½í—˜
   - ?ˆë¶ ê³¼ì •???„í—˜ê³???²½
   - ?¨í•œ ?ì‘ê¸°ì? ë¬¸í™” ì¶©ê²©
   - ë¶í•œ???ê³  ??ê°€ì¡±ì— ?€??ê·¸ë¦¬?€

2. **ë¶í•œ ?¬íšŒ???¤ìƒ**
   - ë¶í•œ???¼ìƒ?í™œê³?ë¬¸í™”
   - ê³„ê¸‰ ?œë„?€ ?¬íšŒ êµ¬ì¡°
   - ë¶í•œ ì£¼ë??¤ì˜ ?¤ì œ ?í™œ??   - ?¸ë? ?¸ê³„???€??ë¶í•œ ì£¼ë????¸ì‹

3. **?¨ë¶ ë¹„êµ?€ ë¬¸í™” ì°¨ì´**
   - ê°™ì? ?¸ì–´, ?¤ë¥¸ ë¬¸í™”
   - ?í™œ ë°©ì‹??ì°¨ì´
   - ê°€ì¹˜ê?ê³??¬ê³ ë°©ì‹??ì°¨ì´
   - ?µì¼???€???„ì‹¤??ê³ ë?

**?¤í† ë¦¬í…”ë§?êµ¬ì¡°:**
1. ?„í¬: ì¶©ê²©?ì´ê±°ë‚˜ ?¥ë?ë¡œìš´ ë¶í•œ ê´€???¬ì‹¤
2. ë°°ê²½: ?ˆë¶ë¯¼ì˜ ë¶í•œ ?í™œ ?Œê°œ
3. ?„ê°œ: êµ¬ì²´?ì¸ ê²½í—˜?´ê³¼ ?í”¼?Œë“œ
4. ?ˆì •: ê°€???¸ìƒ ê¹Šê±°??ê·¹ì ???œê°„
5. ë§ˆë¬´ë¦? ?„ì¬???¶ê³¼ ë©”ì‹œì§€

**ë°°ì—­ êµ¬ì„±:**
- '?ˆë¶ë¯?, '?¸í„°ë·°ì–´', 'ì¹œêµ¬', 'ê°€ì¡? ??- ë¶í•œ???µì–‘ê³??œí˜„???ì—°?¤ëŸ½ê²?ë°˜ì˜
- ê°ì •? ì„ ?¬ì„¸?˜ê²Œ ?œí˜„

**ì£¼ì˜?¬í•­:**
- ë¶í•œ ì£¼ë????€??ì¡´ì¤‘ê³??´í•´ ? ì?
- ? ì •?ì´ê±°ë‚˜ ?ê·¹?ì¸ ?œí˜„ ì§€??- ?©íŠ¸ ê¸°ë°˜???•ë³´ ?„ë‹¬
- ?ˆë¶ë¯¼ì˜ ?¸ê¶Œê³??ˆì „ ê³ ë ¤
- ?µì¼ê³??”í•´??ë©”ì‹œì§€ ?¬í•¨

ê°??€?¬ë§ˆ??ë¶í•œ???¤ìƒ?´ë‚˜ ?ˆë¶ ê³¼ì •???œê°?ìœ¼ë¡??œí˜„?˜ëŠ” ?´ë?ì§€ ?ì„± ?„ë¡¬?„íŠ¸('imagePrompt')ë¥?ë°˜ë“œ???¬í•¨?´ì•¼ ?©ë‹ˆ??

**?´ë?ì§€ ?„ë¡¬?„íŠ¸ ?‘ì„± ê°€?´ë“œ - ë¶í•œ ?´ìŠˆ ?¤í???*:
- ?µì‹¬ ?¤ì›Œ?? documentary style, historical, somber mood, contrast between light and dark, emotional, realistic
- ?¤íë©˜í„°ë¦?ê°™ì? ì§„ì??˜ê³  ?¬ì‹¤?ì¸ ë¶„ìœ„ê¸?- ë¶í•œ???¹ì§•???”ì†Œ ë°˜ì˜ (ê±´ì¶•ë¬? ?˜ìƒ, ?í™œ ëª¨ìŠµ ??
- ?ˆë¶ ê³¼ì •??ê¸´ì¥ê°ê³¼ ê°ì • ?œí˜„
- ?ˆì‹œ: "documentary style photo of North Korean daily life, somber mood, historical atmosphere, realistic depiction, contrast lighting, emotional storytelling"

**ì°¸ê³ ???€ë³?êµ¬ì¡° (êµ¬ì¡°ë§?ì°¨ìš©, ?´ìš©?€ ?ˆë? ?¬ìš© ê¸ˆì?):**

${analysisString}

??êµ¬ì¡°???¨ê³„ë³??ë¦„(?? ?„ì…?’ì „ê°œâ†’?ˆì •?’ê²°ë§?ë§?ì°¸ê³ ?˜ì—¬, "${newKeyword}"ë¥?ì£¼ì œë¡??„ì „???ˆë¡œ??ë¶í•œ ?´ìŠˆ ?¤í† ë¦¬ë? ì°½ì‘?´ì£¼?¸ìš”. ëª¨ë“  ê²°ê³¼ ??ª©??ì§€?•ëœ êµ¬ì¡°??ë§ì¶° JSON ?•ì‹?¼ë¡œ ?œê³µ?´ì£¼?¸ìš”.`;
    } else {
      contents = `"${newKeyword}" ì£¼ì œ???€???„ì „???ˆë¡œ???•ë³´???ìƒ ê¸°íš?ˆì„ ë§Œë“¤??ì£¼ì„¸?? ëª©í‘œ ?ìƒ ê¸¸ì´????${length}?…ë‹ˆ??${lengthGuideline}

**?ˆë? ê·œì¹™:**
- ?„ë˜ ?œê³µ??ë¶„ì„ ?ë£Œ??**?€ë³?êµ¬ì¡°(?¨ê³„ë³??ë¦„)**ë§?ì°¸ê³ ?˜ì„¸??- ?ë³¸ ?ìƒ???•ë³´, ?¬ë?, ?€?¬ëŠ” ?ˆë? ?¬ìš©?˜ì? ë§ˆì„¸??- "${newKeyword}"??ë§ëŠ” ?„ì „???ˆë¡œ???•ë³´?€ ?´ìš©??ì°½ì‘?˜ì„¸??
?ìƒ?€ '?„ì…(ë¬¸ì œ ?œê¸°)', 'ë³¸ë¡ (?µì‹¬ ?•ë³´ ?„ë‹¬)', 'ê²°ë¡ (?”ì•½ ë°??œì–¸)'??êµ¬ì¡°ë¥?ê°€?¸ì•¼ ?©ë‹ˆ?? ??êµ¬ì¡°??ë§ì¶° ê°??¨ê³„ë³??œëª©, ëª©ì , ?ì„¸ ?´ìš©???¬í•¨??êµ¬ì¡°?ì¸ ê°œìš”ë¥??‘ì„±?´ì£¼?¸ìš”.

**?´ë?ì§€ ?„ë¡¬?„íŠ¸ ?‘ì„± ê°€?´ë“œ - ì¹´í…Œê³ ë¦¬ë³??¤í???*:

ì¹´í…Œê³ ë¦¬???°ë¼ ?„ë˜ ?¤ì›Œ?œë? ?œìš©?˜ì„¸??

- **?•ë³´ ?„ë‹¬**: clean style, minimalist, bright lighting, infographic style, clear focus, organized
  ?? "clean minimalist infographic style, bright lighting, organized layout, information visualization, clear focus, professional"

- **IT/?Œí¬**: futuristic, sleek, glowing elements, data visualization, minimalist, high-tech
  ?? "futuristic tech concept, sleek design, glowing blue elements, data visualization, high-tech atmosphere, minimalist"

- **?”ë¦¬/ì¿¡ë°©**: delicious food photography, bright clean lighting, vibrant colors, fresh ingredients
  ?? "delicious food photography, bright natural lighting, vibrant colors, fresh ingredients, appetizing presentation"

- **ë·°í‹°**: beauty shot, soft studio lighting, flawless skin, elegant, close-up on face
  ?? "beauty shot with soft studio lighting, elegant makeup, flawless skin, close-up portrait, professional beauty photography"

- **ê²Œì„**: epic, dynamic action, fantasy art, concept art, glowing magic effects, cinematic
  ?? "epic fantasy game art, dynamic action scene, glowing magic effects, cinematic composition, concept art style"

- **ê±´ê°•**: healthy lifestyle, natural light, vibrant, energetic, clean and fresh
  ?? "healthy lifestyle scene, natural light, vibrant and energetic, clean fresh atmosphere, wellness concept"

- **ë¯¸ìŠ¤?°ë¦¬**: noir style, dramatic shadows, mysterious, suspenseful, foggy, low-key lighting
  ?? "noir mystery style, dramatic shadows, mysterious atmosphere, suspenseful mood, foggy background, low-key lighting"

**ì°¸ê³ ???€ë³?êµ¬ì¡° (êµ¬ì¡°ë§?ì°¨ìš©, ?´ìš©?€ ?ˆë? ?¬ìš© ê¸ˆì?):**

${analysisString}

??êµ¬ì¡°???ë¦„ë§?ì°¸ê³ ?˜ì—¬, "${newKeyword}"ë¥?ì£¼ì œë¡??„ì „???ˆë¡œ???•ë³´?€ ?´ìš©??ì°½ì‘?´ì£¼?¸ìš”. ëª¨ë“  ê²°ê³¼ ??ª©??ì§€?•ëœ êµ¬ì¡°??ë§ì¶° JSON ?•ì‹?¼ë¡œ ?œê³µ?´ì£¼?¸ìš”.`;
    }

    const response = await ai.models.generateContent({
      model: "gemini-2.5-flash",
      contents: contents,
      config: {
        systemInstruction:
          "?¹ì‹ ?€ ì°½ì˜?ì¸ YouTube ?¤í¬ë¦½íŠ¸ ?‘ê? ê²?ê¸°íš?ì…?ˆë‹¤. ?±ê³µ ê³µì‹??ë°”íƒ•?¼ë¡œ ?ˆë¡œ??ì£¼ì œ???€??ê¸°íš?ˆì„ ?ì„±?©ë‹ˆ?? ?”ì²­??ì¹´í…Œê³ ë¦¬?€ ?ìƒ ê¸¸ì´??ë§ì¶° ê²°ê³¼ë¬¼ì˜ ?•ì‹ê³?ë¶„ëŸ‰??ì¡°ì ˆ?´ì£¼?¸ìš”. ëª¨ë“  ?ìŠ¤???¤ëª…?€ ê°€?…ì„±???„í•´ **êµµì? ê¸€??*ë¥??œìš©?˜ê³ , ê¸€ë¨¸ë¦¬ ê¸°í˜¸(-) ?€??ë¬¸ë‹¨ ?¬ì´????ë²ˆì˜ ì¤„ë°”ê¿ˆì„ ?¬ìš©?˜ì—¬ ëª…í™•?˜ê²Œ êµ¬ë¶„?´ì£¼?¸ìš”.",
        responseMimeType: "application/json",
        responseSchema: schema,
      },
    });

    const jsonText = response.text.trim();
    return JSON.parse(jsonText) as NewPlan;
  } catch (error: any) {
    console.error("Error generating new plan:", error);
    
    let userMessage = "???ˆë¡œ??ê¸°íš???ì„± ì¤??¤ë¥˜ê°€ ë°œìƒ?ˆìŠµ?ˆë‹¤.\n\n";
    
    if (error.message && error.message.includes('API_KEY')) {
      userMessage += "?“Œ ?ì¸:\n??API ?¤ê? ? íš¨?˜ì? ?Šê±°??ë§Œë£Œ?˜ì—ˆ?µë‹ˆ??n\n?’¡ ?´ê²° ë°©ë²•:\n??API ?¤ë? ?¤ì‹œ ?•ì¸?˜ê³  ?¬ì„¤?•í•´ì£¼ì„¸??;
    } else if (error.message && error.message.includes('quota')) {
      userMessage += "?“Œ ?ì¸:\n??API ?¬ìš©?‰ì´ ì´ˆê³¼?˜ì—ˆ?µë‹ˆ??n\n?’¡ ?´ê²° ë°©ë²•:\n??? ì‹œ ???¤ì‹œ ?œë„?´ì£¼?¸ìš”\n??Google AI Studio?ì„œ API ?¬ìš©?‰ì„ ?•ì¸?´ì£¼?¸ìš”";
    } else if (error.message && error.message.includes('rate')) {
      userMessage += "?“Œ ?ì¸:\n??API ?”ì²­???ˆë¬´ ë¹ ë¥´ê²?ë°œìƒ?ˆìŠµ?ˆë‹¤\n\n?’¡ ?´ê²° ë°©ë²•:\n??10ì´??•ë„ ê¸°ë‹¤ë¦????¤ì‹œ ?œë„?´ì£¼?¸ìš”";
    } else {
      userMessage += "?“Œ ê°€?¥í•œ ?ì¸:\n???¤ì›Œ?œê? ?ˆë¬´ ë³µì¡?˜ê±°??ë¶€?ì ˆ?©ë‹ˆ??n??AI ?œë²„ ?¼ì‹œ???¤ë¥˜\n???¤íŠ¸?Œí¬ ?°ê²° ë¬¸ì œ\n\n?’¡ ?´ê²° ë°©ë²•:\n????ê°„ë‹¨???¤ì›Œ?œë¡œ ?¤ì‹œ ?œë„?´ì£¼?¸ìš”\n??? ì‹œ ???¤ì‹œ ?œë„?´ì£¼?¸ìš”";
    }
    
    userMessage += `\n\n?”§ ê°œë°œ?ì—ê²??„ë‹¬???¤ë¥˜ ?•ë³´:\n${error.message || '?????†ëŠ” ?¤ë¥˜'}\n${error.stack ? '\nStack: ' + error.stack : ''}`;
    
    throw new Error(userMessage);
  }
};

 
 